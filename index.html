<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FitLog</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#111111" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />

  <style>
    :root{
      --bg:#0f0f10;
      --panel:#171718;
      --panel2:#202022;
      --text:#fff;
      --muted:#bdbdbd;
      --accent:#1db954;
      --input:#2b2b2d;
      --danger:#ff5a5f;
      --line:#2a2a2c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      padding:14px 16px;
      text-align:center;
      font-weight:800;
      font-size:18px;
      background:#000;
      position:sticky;
      top:0;
      z-index:10;
      border-bottom:1px solid #111;
    }
    main{padding:14px; max-width:1000px; margin:0 auto;}
    .tabs{display:flex; gap:8px; margin-bottom:12px;}
    .tab{
      flex:1; padding:10px 12px; border-radius:999px;
      border:1px solid var(--line); background:transparent; color:var(--text); font-weight:800;
    }
    .tab.active{background:var(--panel2); border-color:#3a3a3a;}
    .card{
      background:var(--panel); padding:12px; border-radius:14px;
      border:1px solid var(--line); margin-bottom:10px;
    }
    .titleRow{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px;}
    .pill{
      font-size:12px; background:var(--panel2); border:1px solid #333;
      padding:6px 10px; border-radius:999px; color:var(--muted); white-space:nowrap;
    }
    .small{font-size:12px; color:var(--muted)}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    input, select, textarea{
      width:100%; padding:12px 10px; border-radius:12px; border:none;
      background:var(--input); color:var(--text); outline:none; font-size:16px;
    }
    textarea{min-height:90px; resize:vertical}
    input::placeholder, textarea::placeholder{color:#9a9a9a}
    .label{color:var(--muted); font-size:12px; margin:6px 0}
    .btn{
      width:100%; padding:14px; margin-top:10px; background:var(--accent);
      color:#000; border:none; border-radius:14px; font-size:16px; font-weight:900;
    }
    .btn.secondary{background:transparent; color:var(--text); border:1px solid #3a3a3a; font-weight:800;}
    .btn.danger{background:var(--danger); color:#000;}
    .row{display:flex; gap:10px; align-items:center;}
    .row > *{flex:1}
    .setLine{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px; border-radius:14px; background:#121213; border:1px solid #242424; margin-top:8px;
    }
    .setMain{display:flex; flex-direction:column; gap:2px}
    .setMain strong{font-size:14px}
    .setMeta{color:var(--muted); font-size:12px}
    .miniBtn{
      padding:10px 12px; border-radius:12px; border:1px solid #3a3a3a;
      background:transparent; color:var(--text); font-weight:800; min-width:92px; cursor:pointer;
    }
    .miniBtn.accent{border-color:transparent; background:var(--accent); color:#000;}
    .hidden{display:none !important;}
    .hr{height:1px; background:var(--line); margin:10px 0;}
    .kpiGrid{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;}
    .kpi{background:var(--panel2); border:1px solid #2f2f31; padding:12px; border-radius:14px;}
    .kpi .v{font-size:18px; font-weight:900}
    .kpi .k{font-size:12px; color:var(--muted); margin-top:4px}
    .listItem{
      padding:12px; border-radius:14px; background:#121213; border:1px solid #242424;
      cursor:pointer; display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:8px;
    }
    .listItem strong{font-size:14px}
    .badge{
      font-size:12px; color:var(--muted); background:var(--panel2);
      border:1px solid #333; padding:6px 10px; border-radius:999px; white-space:nowrap;
    }
  </style>
</head>

<body>
<header>FitLog</header>

<main>
  <div class="tabs">
    <button class="tab active" id="tab-workout" onclick="goTab('workout')">Tr√©ning</button>
    <button class="tab" id="tab-calendar" onclick="goTab('calendar')">Kalend√°r</button>
    <button class="tab" id="tab-history" onclick="goTab('history')">Hist√≥ria</button>
    <button class="tab" id="tab-week" onclick="goTab('week')">T√Ω≈æde≈à</button>
  </div>

  <!-- WORKOUT TAB -->
  <section id="screen-workout">
    <div class="card">
      <div class="titleRow">
        <strong>Tr√©ning pre d√°tum</strong>
        <span class="pill" id="pillDate">‚Äî</span>
      </div>

      <div class="grid2">
        <div>
          <div class="label">D√°tum tr√©ningu</div>
          <input type="date" id="workoutDate" />
        </div>
        <div>
          <div class="label">Typ d≈àa (podƒæa kalend√°ra)</div>
          <input id="dayPlan" placeholder="napr. Push / Pull / Legs / Rest" disabled />
        </div>
      </div>

      <div class="label">Pozn√°mka k tr√©ningu (voliteƒæn√©)</div>
      <input id="workoutNote" placeholder="napr. c√≠til som sa dobre / boles≈• ramena..." />
    </div>

    <div class="card">
      <div class="titleRow">
        <strong>Prida≈• s√©riu</strong>
        <span class="pill" id="pillSets">0 s√©ri√≠</span>
      </div>

      <select id="exercise"></select>

      <div class="grid2">
        <div>
          <div class="label">kg</div>
          <input placeholder="napr. 100" id="kg" inputmode="decimal" />
        </div>
        <div>
          <div class="label">opak.</div>
          <input placeholder="napr. 5" id="reps" inputmode="numeric" />
        </div>
      </div>

      <div class="grid2">
        <button class="miniBtn" id="wuBtn" onclick="toggleWarmup()">Warm-up: OFF</button>
        <button class="miniBtn" id="rpeBtn" onclick="toggleRPE()">RPE: OFF</button>
      </div>

      <div id="rpeBox" class="hidden" style="margin-top:10px;">
        <div class="label">RPE (0‚Äì10)</div>
        <input placeholder="napr. 8.5" id="rpe" inputmode="decimal" />
      </div>

      <button class="btn" onclick="saveSet()">Ulo≈æi≈• s√©riu</button>
    </div>

    <div class="card">
      <div class="titleRow">
        <strong>Log</strong>
        <div class="row" style="max-width:210px;">
          <button class="miniBtn" onclick="clearLog()">Vymaza≈•</button>
        </div>
      </div>
      <div id="log"></div>
    </div>

    <button class="btn danger" onclick="finishWorkout()">Ulo≈æi≈• tr√©ning</button>
    <div class="small" style="margin-top:8px;">
      Tr√©ning sa ulo≈æ√≠ pod zvolen√Ωm d√°tumom a bude ho vidie≈• v Hist√≥rii + T√Ω≈ædennom sum√°ri.
    </div>
  </section>

  <!-- CALENDAR TAB -->
  <section id="screen-calendar" class="hidden">
    <div class="card">
      <div class="titleRow">
        <strong>Kalend√°r ‚Äì pl√°n dn√≠</strong>
        <span class="pill">Po‚ÄìNe</span>
      </div>
      <div class="small">Nastav si, ƒço ide≈° ktor√Ω de≈à. Toto sa potom automaticky uk√°≈æe v tr√©ningu podƒæa d√°tumu.</div>

      <div class="hr"></div>

      <div class="grid2">
        <div><div class="label">Pondelok</div><input id="plan_mon" placeholder="napr. Push" /></div>
        <div><div class="label">Utorok</div><input id="plan_tue" placeholder="napr. Pull" /></div>
        <div><div class="label">Streda</div><input id="plan_wed" placeholder="napr. Legs" /></div>
        <div><div class="label">≈†tvrtok</div><input id="plan_thu" placeholder="napr. Rest" /></div>
        <div><div class="label">Piatok</div><input id="plan_fri" placeholder="napr. Upper" /></div>
        <div><div class="label">Sobota</div><input id="plan_sat" placeholder="napr. Lower" /></div>
        <div><div class="label">Nedeƒæa</div><input id="plan_sun" placeholder="napr. Rest" /></div>
        <div>
          <div class="label">R√Ωchla voƒæba</div>
          <select id="quickPlan" onchange="applyQuickPlan()">
            <option value="">‚Äî</option>
            <option value="PPL">PPL (Po Push, Ut Pull, St Legs, Pi Push, So Pull, Ne Legs)</option>
            <option value="UL">Upper/Lower (Po Upper, Ut Lower, ≈†t Upper, Pi Lower)</option>
            <option value="REST">V≈°etko Rest</option>
          </select>
        </div>
      </div>

      <button class="btn" onclick="savePlan()">Ulo≈æi≈• kalend√°r</button>
    </div>

    <div class="card">
      <div class="titleRow">
        <strong>Prida≈• vlastn√Ω cvik</strong>
        <span class="pill">do kni≈ænice</span>
      </div>

      <div class="label">N√°zov cviku</div>
      <input id="newExName" placeholder="napr. Incline DB Press" />

      <div class="label">Pozn√°mka (voliteƒæn√©)</div>
      <input id="newExNote" placeholder="napr. 30¬∞ laviƒçka / kontrolovan√Ω pohyb" />

      <button class="btn secondary" onclick="addExercise()">Prida≈• cvik</button>
      <div class="hr"></div>

      <div class="small">
        Aby bol cvik glob√°lne (PC aj iPhone), pridaj ho aj do <b>exercises.json</b> v GitHube.
      </div>

      <div class="label">Export (skop√≠ruj a vlo≈æ do exercises.json)</div>
      <textarea id="exExport" readonly placeholder="Tu sa zobraz√≠ JSON po pridan√≠ cviku..."></textarea>

      <button class="btn secondary" onclick="copyExport()">Kop√≠rova≈• export</button>

      <div class="small" style="margin-top:8px;">
        Vlastn√© cviky zostan√∫ ulo≈æen√© lok√°lne v zariaden√≠.
      </div>
    </div>
  </section>

  <!-- HISTORY TAB -->
  <section id="screen-history" class="hidden">
    <div class="card">
      <div class="titleRow">
        <strong>Hist√≥ria tr√©ningov</strong>
        <span class="pill" id="pillHistory">0</span>
      </div>
      <div id="historyList"></div>
    </div>

    <div class="card hidden" id="historyDetailCard">
      <div class="titleRow">
        <strong id="historyDetailTitle">Detail</strong>
        <button class="miniBtn" onclick="closeHistoryDetail()">Zavrie≈•</button>
      </div>
      <div id="historyDetail"></div>
    </div>
  </section>

  <!-- WEEK TAB -->
  <section id="screen-week" class="hidden">
    <div class="card">
      <div class="titleRow">
        <strong>T√Ω≈ædenn√Ω sum√°r</strong>
        <span class="pill" id="pillWeekRange">‚Äî</span>
      </div>

      <div class="grid2">
        <button class="miniBtn" onclick="shiftWeek(-7)">‚Üê Predo≈°l√Ω</button>
        <button class="miniBtn" onclick="shiftWeek(7)">ƒéal≈°√≠ ‚Üí</button>
      </div>

      <div class="hr"></div>

      <div class="kpiGrid">
        <div class="kpi"><div class="v" id="kpiWorkouts">0</div><div class="k">tr√©ningov</div></div>
        <div class="kpi"><div class="v" id="kpiSets">0</div><div class="k">s√©ri√≠</div></div>
        <div class="kpi"><div class="v" id="kpiVolume">0</div><div class="k">objem (kg√óopak.)</div></div>
      </div>

      <div class="hr"></div>

      <div id="weekList" class="small">‚Äî</div>
    </div>
  </section>
</main>

<script>
// üîÑ AUTO RELOAD PO UPDATE SERVICE WORKERA
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.addEventListener("controllerchange", () => {
      window.location.reload();
    });
  }

  // üì¶ REGISTR√ÅCIA SERVICE WORKERA
  if ("serviceWorker" in navigator") {
    navigator.serviceWorker.register("sw.js");
  }

  const $ = (id) => document.getElementById(id);
  const APP_VERSION = "1.0.3";


  // üîÅ FALLBACK CVIKY (len keƒè by ne≈°iel exercises.json)
  const BASE_EXERCISES = [
    { id: "squat", label: "Drep" },
    { id: "bench_press", label: "Bench press" },
    { id: "deadlift", label: "M≈ïtvy ≈•ah" }
  ];

  // --- Storage keys ---
  const KEY_PLAN = "fitlog_plan_v1";
  const KEY_ACTIVE = "fitlog_active_v1";
  const KEY_HISTORY = "fitlog_history_v1";
  const KEY_WEEK_ANCHOR = "fitlog_week_anchor_v1";

  // --- State ---
  let warmup = false;
  let useRPE = false;
  let active = { date: todayISO(), note: "", sets: [] };
  let exercises = [];              // d√¥le≈æit√©: NEVOL√ÅME loadExercises() tu
  let plan = loadPlan();
  let history = loadHistory();
  let weekAnchor = loadWeekAnchor();

  // --- Init UI ---
  init();

  async function init(){
    $("workoutDate").value = active.date || todayISO();
    $("pillDate").innerText = formatDate(active.date);

    const savedDraft = localStorage.getItem(KEY_ACTIVE);
    if (savedDraft) {
      try { active = JSON.parse(savedDraft); } catch(e){}
      $("workoutDate").value = active.date || todayISO();
      $("workoutNote").value = active.note || "";
      $("pillDate").innerText = formatDate(active.date || todayISO());
    }

    setPlanInputs();

    $("workoutDate").addEventListener("change", () => {
      const d = $("workoutDate").value || todayISO();
      active.date = d;
      saveDraft();
      $("pillDate").innerText = formatDate(d);
      updateDayPlanField();
      renderLog();
    });

    $("workoutNote").addEventListener("input", () => {
      active.note = $("workoutNote").value || "";
      saveDraft();
    });

    await populateExercises();
    updateDayPlanField();
    renderLog();
    renderHistory();
    renderWeek();
  }

  // --- Tabs ---
  function goTab(name){
    const tabs = ["workout","calendar","history","week"];
    tabs.forEach(t => {
      $("tab-"+t).classList.toggle("active", t===name);
      $("screen-"+t).classList.toggle("hidden", t!==name);
    });
    if (name==="history") renderHistory();
    if (name==="week") renderWeek();
    if (name==="workout") { updateDayPlanField(); renderLog(); }
    if (name==="calendar") { setPlanInputs(); }
  }

  // --- Workout ---
  function toggleWarmup(){
    warmup = !warmup;
    $("wuBtn").classList.toggle("accent", warmup);
    $("wuBtn").textContent = warmup ? "Warm-up: ON" : "Warm-up: OFF";
    saveDraft();
  }

  function toggleRPE(){
    useRPE = !useRPE;
    $("rpeBtn").classList.toggle("accent", useRPE);
    $("rpeBtn").textContent = useRPE ? "RPE: ON" : "RPE: OFF";
    $("rpeBox").classList.toggle("hidden", !useRPE);
    if (!useRPE) $("rpe").value = "";
    saveDraft();
  }

  function saveSet(){
    const exId = $("exercise").value;
    const exLabel = $("exercise").selectedOptions[0]?.textContent || exId;

    const kgRaw = ($("kg").value || "").trim();
    const repsRaw = ($("reps").value || "").trim();
    const rpeRaw = ($("rpe").value || "").trim();

    if (!kgRaw || !repsRaw) return alert("Zadaj kg aj opakovania.");

    const kg = Number(kgRaw.replace(",", "."));
    const reps = Number(repsRaw);
    const rpe = (useRPE && rpeRaw) ? Number(rpeRaw.replace(",", ".")) : null;

    if (!Number.isFinite(kg) || kg < 0) return alert("Zl√© kg");
    if (!Number.isFinite(reps) || reps <= 0) return alert("Zl√© opakovania");
    if (rpe !== null && (!Number.isFinite(rpe) || rpe < 0 || rpe > 10)) return alert("RPE 0‚Äì10");

    active.sets.push({ exId, exLabel, kg, reps, rpe, warmup, ts: new Date().toISOString() });

    $("kg").value = "";
    $("reps").value = "";
    $("rpe").value = "";

    saveDraft();
    renderLog();
  }

  function renderLog(){
    $("pillDate").innerText = formatDate(active.date || $("workoutDate").value || todayISO());
    $("pillSets").innerText = `${active.sets.length} s√©ri√≠`;

    const div = $("log");
    div.innerHTML = "";
    if (active.sets.length === 0) {
      div.innerHTML = `<div class="small">Zatiaƒæ ≈æiadne s√©rie.</div>`;
      return;
    }

    [...active.sets].slice().reverse().forEach((s, idx) => {
      const isWU = s.warmup ? " ‚Ä¢ WU" : "";
      const rpeTxt = (s.rpe !== null && s.rpe !== undefined) ? ` ‚Ä¢ RPE ${s.rpe}` : "";
      div.innerHTML += `
        <div class="setLine">
          <div class="setMain">
            <strong>${s.exLabel}</strong>
            <div class="setMeta">${s.kg} kg √ó ${s.reps}${rpeTxt}${isWU}</div>
          </div>
          <button class="miniBtn" onclick="deleteSet(${active.sets.length - 1 - idx})">Zmaza≈•</button>
        </div>
      `;
    });
  }

  function deleteSet(index){
    active.sets.splice(index, 1);
    saveDraft();
    renderLog();
  }

  function clearLog(){
    if (!confirm("Vymaza≈• v≈°etky s√©rie v tomto dni?")) return;
    active.sets = [];
    saveDraft();
    renderLog();
  }

  function finishWorkout(){
    if (active.sets.length === 0) return alert("Najprv ulo≈æ aspo≈à jednu s√©riu.");

    const d = active.date || $("workoutDate").value || todayISO();
    const entry = {
      id: uid(),
      date: d,
      dayType: getDayPlanForDate(d) || "",
      note: active.note || "",
      sets: active.sets,
      savedAt: new Date().toISOString()
    };

    history = history.filter(h => h.date !== d);
    history.unshift(entry);
    saveHistory();

    active = { date: d, note: "", sets: [] };
    $("workoutNote").value = "";
    warmup = false;
    useRPE = false;
    $("wuBtn").classList.remove("accent");
    $("wuBtn").textContent = "Warm-up: OFF";
    $("rpeBtn").classList.remove("accent");
    $("rpeBtn").textContent = "RPE: OFF";
    $("rpeBox").classList.add("hidden");
    $("rpe").value = "";

    saveDraft();
    renderLog();
    renderHistory();
    renderWeek();
    alert("Tr√©ning ulo≈æen√Ω.");
  }

  function saveDraft(){
    localStorage.setItem(KEY_ACTIVE, JSON.stringify(active));
  }

  // --- Exercises (GLOBAL from exercises.json + LOCAL custom) ---
  function loadExercisesLocal() {
    const saved = localStorage.getItem("fitlog_custom_exercises_v1");
    try { return saved ? JSON.parse(saved) : []; } catch { return []; }
  }

  function loadGlobalCached() {
    const saved = localStorage.getItem("fitlog_global_exercises_v1");
    try { return saved ? JSON.parse(saved) : []; } catch { return []; }
  }

  async function syncFromGitHubExercises() {
    const url = `./exercises.json?v=${APP_VERSION}`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("Cannot load exercises.json");
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error("exercises.json must be an array");
    localStorage.setItem("fitlog_global_exercises_v1", JSON.stringify(data));
    return data;
  }

  async function loadExercises() {
    let global = [];
    try { global = await syncFromGitHubExercises(); }
    catch { global = loadGlobalCached(); }

    // fallback ak nem√°me niƒç ani v cache
    if (!Array.isArray(global) || global.length === 0) global = BASE_EXERCISES;

    const custom = loadExercisesLocal();
    const map = new Map();

    [...global, ...custom].forEach(e => {
      if (e && e.id && e.label) map.set(e.id, e);
    });

    return [...map.values()].sort((a,b) => String(a.label).localeCompare(String(b.label)));
  }

  async function populateExercises(){
    const sel = $("exercise");
    sel.innerHTML = "";
    exercises = await loadExercises();
    exercises.forEach(e => {
      const opt = document.createElement("option");
      opt.value = e.id;
      opt.textContent = e.label;
      sel.appendChild(opt);
    });
  }

  function addExercise(){
    const name = ($("newExName").value || "").trim();
    if (!name) return alert("Zadaj n√°zov cviku.");

    const item = { id: "u_" + uid(), label: name };
    const custom = Array.isArray(loadExercisesLocal()) ? loadExercisesLocal() : [];
    custom.push(item);
    localStorage.setItem("fitlog_custom_exercises_v1", JSON.stringify(custom));

    $("newExName").value = "";
    $("newExNote").value = "";

    const box = $("exExport");
    if (box) box.value = JSON.stringify(item);

    populateExercises();
    alert("Cvik pridan√Ω lok√°lne. Skop√≠ruj export do exercises.json na GitHube a commitni.");
  }

  function copyExport(){
    const box = $("exExport");
    if (!box || !box.value) return alert("Najprv pridaj cvik.");
    box.select();
    document.execCommand("copy");
    alert("Export skop√≠rovan√Ω.");
  }

  // --- Calendar plan ---
  function loadPlan(){
    const saved = localStorage.getItem(KEY_PLAN);
    if (saved) { try { return JSON.parse(saved) || {}; } catch(e){} }
    return { mon:"", tue:"", wed:"", thu:"", fri:"", sat:"", sun:"" };
  }

  function setPlanInputs(){
    $("plan_mon").value = plan.mon || "";
    $("plan_tue").value = plan.tue || "";
    $("plan_wed").value = plan.wed || "";
    $("plan_thu").value = plan.thu || "";
    $("plan_fri").value = plan.fri || "";
    $("plan_sat").value = plan.sat || "";
    $("plan_sun").value = plan.sun || "";
  }

  function savePlan(){
    plan = {
      mon: $("plan_mon").value || "",
      tue: $("plan_tue").value || "",
      wed: $("plan_wed").value || "",
      thu: $("plan_thu").value || "",
      fri: $("plan_fri").value || "",
      sat: $("plan_sat").value || "",
      sun: $("plan_sun").value || ""
    };
    localStorage.setItem(KEY_PLAN, JSON.stringify(plan));
    updateDayPlanField();
    alert("Kalend√°r ulo≈æen√Ω.");
  }

  function applyQuickPlan(){
    const v = $("quickPlan").value;
    if (!v) return;

    if (v==="PPL"){
      $("plan_mon").value = "Push";
      $("plan_tue").value = "Pull";
      $("plan_wed").value = "Legs";
      $("plan_thu").value = "Rest";
      $("plan_fri").value = "Push";
      $("plan_sat").value = "Pull";
      $("plan_sun").value = "Legs";
    }
    if (v==="UL"){
      $("plan_mon").value = "Upper";
      $("plan_tue").value = "Lower";
      $("plan_wed").value = "Rest";
      $("plan_thu").value = "Upper";
      $("plan_fri").value = "Lower";
      $("plan_sat").value = "Rest";
      $("plan_sun").value = "Rest";
    }
    if (v==="REST"){
      ["mon","tue","wed","thu","fri","sat","sun"].forEach(k => $("plan_"+k).value = "Rest");
    }
  }

  function getDayPlanForDate(dateISO){
    const d = new Date(dateISO + "T00:00:00");
    const day = d.getDay();
    if (day===1) return plan.mon || "";
    if (day===2) return plan.tue || "";
    if (day===3) return plan.wed || "";
    if (day===4) return plan.thu || "";
    if (day===5) return plan.fri || "";
    if (day===6) return plan.sat || "";
    return plan.sun || "";
  }

  function updateDayPlanField(){
    const d = $("workoutDate").value || todayISO();
    $("dayPlan").value = getDayPlanForDate(d) || "";
  }

  // --- History ---
  function uid(){
    return crypto?.randomUUID?.() || (String(Date.now()) + Math.random().toString(16).slice(2));
  }

  function loadHistory(){
    const saved = localStorage.getItem(KEY_HISTORY);
    if (!saved) return [];
    try { return JSON.parse(saved) || []; } catch { return []; }
  }

  function saveHistory(){
    localStorage.setItem(KEY_HISTORY, JSON.stringify(history));
  }

  function renderHistory(){
    history = loadHistory();
    $("pillHistory").innerText = String(history.length);
    const list = $("historyList");
    list.innerHTML = "";
    $("historyDetailCard").classList.add("hidden");

    if (history.length === 0) {
      list.innerHTML = `<div class="small">Zatiaƒæ ≈æiadne ulo≈æen√© tr√©ningy.</div>`;
      return;
    }

    history.slice(0, 60).forEach(h => {
      const sets = h.sets?.length || 0;
      const dayType = h.dayType ? ` ‚Ä¢ ${h.dayType}` : "";
      list.innerHTML += `
        <div class="listItem" onclick="openHistoryDetail('${h.id}')">
          <div>
            <strong>${formatDate(h.date)}</strong>
            <div class="small">${sets} s√©ri√≠${dayType}</div>
          </div>
          <span class="badge">Detail</span>
        </div>
      `;
    });
  }

  function openHistoryDetail(id){
    const h = history.find(x => x.id === id);
    if (!h) return;

    $("historyDetailCard").classList.remove("hidden");
    $("historyDetailTitle").innerText = `${formatDate(h.date)} ${h.dayType ? "‚Ä¢ " + h.dayType : ""}`;

    const div = $("historyDetail");
    div.innerHTML = "";

    if (h.note) {
      div.innerHTML += `<div class="card" style="margin:0 0 10px 0;">
        <strong>Pozn√°mka:</strong><div class="small" style="margin-top:6px;">${escapeHTML(h.note)}</div></div>`;
    }

    const grouped = {};
    (h.sets || []).forEach(s => {
      const key = s.exLabel || s.exId;
      grouped[key] = grouped[key] || [];
      grouped[key].push(s);
    });

    Object.keys(grouped).forEach(ex => {
      const arr = grouped[ex];
      div.innerHTML += `<div class="card"><strong>${escapeHTML(ex)}</strong>
        <div class="small" style="margin-top:8px;">${arr.map((s,i)=>{
          const wu = s.warmup ? " (WU)" : "";
          const rpe = (s.rpe!==null && s.rpe!==undefined) ? ` ‚Ä¢ RPE ${s.rpe}` : "";
          return `#${i+1}: ${s.kg}√ó${s.reps}${wu}${rpe}`;
        }).join("<br>")}</div></div>`;
    });

    div.innerHTML += `<button class="btn secondary" onclick="loadWorkoutFromHistory('${h.date}')">Naƒç√≠ta≈• do tr√©ningu</button>`;
  }

  function closeHistoryDetail(){
    $("historyDetailCard").classList.add("hidden");
  }

  function loadWorkoutFromHistory(dateISO){
    const h = history.find(x => x.date === dateISO);
    if (!h) return;

    active = { date: h.date, note: h.note || "", sets: [...(h.sets || [])] };
    $("workoutDate").value = active.date;
    $("workoutNote").value = active.note || "";
    saveDraft();
    updateDayPlanField();
    renderLog();
    goTab("workout");
    alert("Tr√©ning naƒç√≠tan√Ω do edit√°cie.");
  }

  // --- Weekly summary ---
  function loadWeekAnchor(){
    const saved = localStorage.getItem(KEY_WEEK_ANCHOR);
    if (saved) return saved;
    const d = todayISO();
    localStorage.setItem(KEY_WEEK_ANCHOR, d);
    return d;
  }

  function shiftWeek(deltaDays){
    const d = new Date(weekAnchor + "T00:00:00");
    d.setDate(d.getDate() + deltaDays);
    weekAnchor = toISO(d);
    localStorage.setItem(KEY_WEEK_ANCHOR, weekAnchor);
    renderWeek();
  }

  function renderWeek(){
    history = loadHistory();
    const range = weekRangeFor(weekAnchor);
    $("pillWeekRange").innerText = `${formatDate(range.start)} ‚Äì ${formatDate(range.end)}`;

    const inWeek = history.filter(h => h.date >= range.start && h.date <= range.end);
    const workouts = inWeek.length;
    const sets = inWeek.reduce((acc,h)=>acc + ((h.sets||[]).length), 0);
    const volume = inWeek.reduce((acc,h)=>acc + (h.sets||[]).reduce((a,s)=>a + (Number(s.kg)||0)*(Number(s.reps)||0), 0), 0);

    $("kpiWorkouts").innerText = String(workouts);
    $("kpiSets").innerText = String(sets);
    $("kpiVolume").innerText = String(Math.round(volume));

    const list = $("weekList");
    if (inWeek.length === 0) {
      list.innerHTML = "≈Ωiadne tr√©ningy v tomto t√Ω≈ædni.";
      return;
    }

    list.innerHTML = inWeek
      .sort((a,b)=>a.date.localeCompare(b.date))
      .map(h => {
        const v = (h.sets||[]).reduce((a,s)=>a + (Number(s.kg)||0)*(Number(s.reps)||0), 0);
        const t = h.dayType ? ` ‚Ä¢ ${h.dayType}` : "";
        return `<div class="listItem" onclick="goTab('history'); openHistoryDetail('${h.id}')">
          <div>
            <strong>${formatDate(h.date)}${t}</strong>
            <div class="small">${(h.sets||[]).length} s√©ri√≠ ‚Ä¢ objem ${Math.round(v)}</div>
          </div>
          <span class="badge">Detail</span>
        </div>`;
      }).join("");
  }

  function weekRangeFor(anchorISO){
    const d = new Date(anchorISO + "T00:00:00");
    const day = d.getDay();
    const diffToMon = (day === 0 ? -6 : 1 - day);
    const start = new Date(d);
    start.setDate(d.getDate() + diffToMon);
    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    return { start: toISO(start), end: toISO(end) };
  }

  // --- Helpers ---
  function todayISO(){ return toISO(new Date()); }
  function toISO(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }
  function formatDate(iso){
    if (!iso) return "‚Äî";
    const [y,m,d] = iso.split("-");
    return `${d}.${m}.${y}`;
  }
  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }
</script>
</body>
</html>




