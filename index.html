<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FitLog</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#111111" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />

  <style>
    :root{
      --bg:#0f0f10;
      --panel:#171718;
      --panel2:#202022;
      --text:#fff;
      --muted:#bdbdbd;
      --accent:#1db954;
      --input:#2b2b2d;
      --danger:#ff5a5f;
      --line:#2a2a2c;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      padding:14px 16px;
      text-align:center;
      font-weight:800;
      font-size:18px;
      background:#000;
      position:sticky;
      top:0;
      z-index:10;
      border-bottom:1px solid #111;
    }
    main{padding:14px; max-width:1000px; margin:0 auto;}
    .tabs{display:flex; gap:8px; margin-bottom:12px;}
    .tab{
      flex:1; padding:10px 12px; border-radius:999px;
      border:1px solid var(--line); background:transparent; color:var(--text); font-weight:800;
    }
    .tab.active{background:var(--panel2); border-color:#3a3a3a;}
    .card{
      background:var(--panel); padding:12px; border-radius:14px;
      border:1px solid var(--line); margin-bottom:10px;
    }
    .titleRow{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px;}
    .pill{
      font-size:12px; background:var(--panel2); border:1px solid #333;
      padding:6px 10px; border-radius:999px; color:var(--muted); white-space:nowrap;
    }
    .small{font-size:12px; color:var(--muted)}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    input, select, textarea{
      width:100%; padding:12px 10px; border-radius:12px; border:none;
      background:var(--input); color:var(--text); outline:none; font-size:16px;
    }
    textarea{min-height:90px; resize:vertical}
    input::placeholder, textarea::placeholder{color:#9a9a9a}
    .label{color:var(--muted); font-size:12px; margin:6px 0}
    .btn{
      width:100%; padding:14px; margin-top:10px; background:var(--accent);
      color:#000; border:none; border-radius:14px; font-size:16px; font-weight:900;
    }
    .btn.secondary{background:transparent; color:var(--text); border:1px solid #3a3a3a; font-weight:800;}
    .btn.danger{background:var(--danger); color:#000;}
    .row{display:flex; gap:10px; align-items:center;}
    .row > *{flex:1}
    .setLine{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px; border-radius:14px; background:#121213; border:1px solid #242424; margin-top:8px;
    }
    .setMain{display:flex; flex-direction:column; gap:2px}
    .setMain strong{font-size:14px}
    .setMeta{color:var(--muted); font-size:12px}
    .miniBtn{
      padding:10px 12px; border-radius:12px; border:1px solid #3a3a3a;
      background:transparent; color:var(--text); font-weight:800; min-width:92px; cursor:pointer;
    }
    .miniBtn.accent{border-color:transparent; background:var(--accent); color:#000;}
    .hidden{display:none !important;}
    .hr{height:1px; background:var(--line); margin:10px 0;}
    .kpiGrid{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;}
    .kpi{background:var(--panel2); border:1px solid #2f2f31; padding:12px; border-radius:14px;}
    .kpi .v{font-size:18px; font-weight:900}
    .kpi .k{font-size:12px; color:var(--muted); margin-top:4px}
    .listItem{
      padding:12px; border-radius:14px; background:#121213; border:1px solid #242424;
      cursor:pointer; display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:8px;
    }
    .listItem strong{font-size:14px}
    .badge{
      font-size:12px; color:var(--muted); background:var(--panel2);
      border:1px solid #333; padding:6px 10px; border-radius:999px; white-space:nowrap;
    }

    /* Calendar */
    .calHeader{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .calTitle{font-weight:900}
    .calGrid{display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-top:10px;}
    .calDow{font-size:11px; color:var(--muted); text-align:center;}
    .calDay{
      background:#121213; border:1px solid #242424; border-radius:12px;
      padding:10px 8px; min-height:54px; cursor:pointer;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .calDay.muted{opacity:.35}
    .calNum{font-weight:900; font-size:13px}
    .calTag{font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .dot{width:8px; height:8px; border-radius:99px; background:var(--accent); display:inline-block; margin-right:6px;}
    .calTagRow{display:flex; align-items:center; gap:6px;}
  </style>
</head>

<body>
<header>FitLog</header>

<main>
  <div class="tabs">
    <button class="tab active" id="tab-workout" onclick="goTab('workout')">Tr√©ning</button>
    <button class="tab" id="tab-calendar" onclick="goTab('calendar')">Kalend√°r</button>
    <button class="tab" id="tab-history" onclick="goTab('history')">Hist√≥ria</button>
    <button class="tab" id="tab-week" onclick="goTab('week')">T√Ω≈æde≈à</button>
  </div>

  <!-- WORKOUT TAB -->
  <section id="screen-workout">
    <div class="card">
      <div class="titleRow">
        <strong>Tr√©ning pre d√°tum</strong>
        <span class="pill" id="pillDate">‚Äî</span>
      </div>

      <div class="grid2">
        <div>
          <div class="label">D√°tum tr√©ningu</div>
          <input type="date" id="workoutDate" />
        </div>
        <div>
          <div class="label">Typ d≈àa (tvoj n√°zov)</div>
          <input id="dayType" placeholder="napr. Push / Pull / Legs / Rest" />
        </div>
      </div>

      <div class="label">Pozn√°mka k tr√©ningu (voliteƒæn√©)</div>
      <input id="workoutNote" placeholder="napr. c√≠til som sa dobre / boles≈• ramena..." />
    </div>


    <div class="card">
      <div class="titleRow">
        <strong>≈†abl√≥na tr√©ningu</strong>
        <span class="pill" id="pillTpl">‚Äî</span>
      </div>

      <div class="grid2">
        <select id="tplSelectWorkout"></select>
        <button class="miniBtn accent" onclick="applyTemplateToToday()">Pou≈æi≈•</button>
      </div>

      <div class="small" style="margin-top:10px;">
        ≈†abl√≥ny s√∫ <b>lok√°lne v zariaden√≠</b>. Nastav√≠≈° ich v z√°lo≈æke Kalend√°r ‚Üí ≈†abl√≥ny.
      </div>

      <div id="tplPlanWrap" class="hidden" style="margin-top:10px;">
        <div class="label">Cviky dne≈°n√©ho tr√©ningu (klikni pre r√Ωchly v√Ωber)</div>
        <div id="tplPlanList"></div>
        <div class="grid2" style="margin-top:10px;">
          <button class="btn secondary" onclick="clearTodayPlan()">Vymaza≈• pl√°n</button>
          <button class="btn secondary" onclick="savePlanAsTemplate()">Ulo≈æi≈• dne≈°n√Ω pl√°n ako ≈°abl√≥nu</button>
        </div>
      </div>
    </div>


    <div class="card">
      <div class="titleRow">
        <strong>Prida≈• s√©riu</strong>
        <span class="pill" id="pillSets">0 s√©ri√≠</span>
      </div>

      <select id="exercise"></select>

      <div class="grid2">
        <div>
          <div class="label">kg</div>
          <input placeholder="napr. 100" id="kg" inputmode="decimal" />
        </div>
        <div>
          <div class="label">opak.</div>
          <input placeholder="napr. 5" id="reps" inputmode="numeric" />
        </div>
      </div>

      <div class="grid2">
        <button class="miniBtn" id="wuBtn" onclick="toggleWarmup()">Warm-up: OFF</button>
        <button class="miniBtn" id="rpeBtn" onclick="toggleRPE()">RPE: OFF</button>
      </div>

      <div id="rpeBox" class="hidden" style="margin-top:10px;">
        <div class="label">RPE (0‚Äì10)</div>
        <input placeholder="napr. 8.5" id="rpe" inputmode="decimal" />
      </div>

      <button class="btn" onclick="saveSet()">Ulo≈æi≈• s√©riu</button>
    </div>

    <div class="card">
      <div class="titleRow">
        <strong>S√©rie</strong>
        <div class="row" style="max-width:210px;">
          <button class="miniBtn" onclick="clearLog()">Vymaza≈•</button>
        </div>
      </div>
      <div id="log"></div>
    </div>

    <button class="btn danger" onclick="finishWorkout()">Ulo≈æi≈• tr√©ning</button>
    <div class="small" style="margin-top:8px;">
      Tr√©ning sa ulo≈æ√≠ pod zvolen√Ωm d√°tumom a bude ho vidie≈• v Hist√≥rii + T√Ω≈ædennom sum√°ri + Kalend√°ri.
    </div>
  </section>

  <!-- CALENDAR TAB -->
  <section id="screen-calendar" class="hidden">
    <div class="card">
      <div class="titleRow">
        <strong>Kalend√°r tr√©ningov</strong>
        <span class="pill" id="pillCalRange">‚Äî</span>
      </div>

      <div class="calHeader">
        <button class="miniBtn" onclick="shiftMonth(-1)">‚Üê</button>
        <div class="calTitle" id="calTitle">‚Äî</div>
        <button class="miniBtn" onclick="shiftMonth(1)">‚Üí</button>
      </div>

      <div class="calGrid" id="calDow"></div>
      <div class="calGrid" id="calGrid"></div>

      <div class="small" style="margin-top:10px;">
        Klikni na de≈à: otvor√≠ sa tr√©ning pre ten d√°tum (ak existuje, vie≈° ho naƒç√≠ta≈• z Hist√≥rie).
      </div>
    </div>


    <div class="card">
      <div class="titleRow">
        <strong>≈†abl√≥ny</strong>
        <span class="pill">lok√°lne</span>
      </div>

      <div class="grid2">
        <select id="tplSelect"></select>
        <button class="miniBtn accent" onclick="createTemplate()">Nov√°</button>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <button class="btn secondary" onclick="renameTemplate()">Premenova≈•</button>
        <button class="btn secondary" onclick="deleteTemplate()">Zmaza≈•</button>
      </div>

      <div class="hr"></div>

      <div class="label">Prida≈• cvik do ≈°abl√≥ny</div>
      <div class="grid2">
        <select id="tplAddExercise"></select>
        <button class="miniBtn accent" onclick="addExerciseToTemplate()">Prida≈•</button>
      </div>

      <div class="label" style="margin-top:10px;">Cviky v ≈°abl√≥ne</div>
      <div id="tplItems" class="small">‚Äî</div>
    </div>


    <div class="card">
      <div class="titleRow">
        <strong>Prida≈• vlastn√Ω cvik</strong>
        <span class="pill">lok√°lne / export</span>
      </div>

      <div class="label">N√°zov cviku</div>
      <input id="newExName" placeholder="napr. Incline DB Press" />

      <div class="label">Pozn√°mka (voliteƒæn√©)</div>
      <input id="newExNote" placeholder="napr. 30¬∞ laviƒçka / kontrolovan√Ω pohyb" />

      <button class="btn secondary" onclick="addExercise()">Prida≈• cvik (lok√°lne)</button>

      <div class="hr"></div>

      <div class="small">
        Glob√°lna synchroniz√°cia (PC ‚Üî iPhone) funguje tak, ≈æe cvik prid√°≈° do <b>exercises.json</b> v GitHube.
      </div>

      <div class="label">Export (skop√≠ruj do exercises.json)</div>
      <textarea id="exExport" readonly placeholder="Tu sa zobraz√≠ JSON po pridan√≠ cviku..."></textarea>

      <div class="grid2">
        <button class="btn secondary" onclick="copyExport()">Kop√≠rova≈• export</button>
        <button class="btn secondary" onclick="forceRefreshExercises()">Obnovi≈• cviky</button>
      </div>

      <div class="small" style="margin-top:8px;">
        Tip: po √∫prave exercises.json zv√Ω≈° APP_VERSION. iPhone si potom s√°m natiahne nov√© cviky.
      </div>
    </div>
  </section>

  <!-- HISTORY TAB -->
  <section id="screen-history" class="hidden">
    <div class="card">
      <div class="titleRow">
        <strong>Hist√≥ria tr√©ningov</strong>
        <span class="pill" id="pillHistory">0</span>
      </div>
      <div id="historyList"></div>
    </div>

    <div class="card hidden" id="historyDetailCard">
      <div class="titleRow">
        <strong id="historyDetailTitle">Detail</strong>
        <button class="miniBtn" onclick="closeHistoryDetail()">Zavrie≈•</button>
      </div>
      <div id="historyDetail"></div>
    </div>
  </section>

  <!-- WEEK TAB -->
  <section id="screen-week" class="hidden">
    <div class="card">
      <div class="titleRow">
        <strong>T√Ω≈ædenn√Ω sum√°r</strong>
        <span class="pill" id="pillWeekRange">‚Äî</span>
      </div>

      <div class="grid2">
        <button class="miniBtn" onclick="shiftWeek(-7)">‚Üê Predo≈°l√Ω</button>
        <button class="miniBtn" onclick="shiftWeek(7)">ƒéal≈°√≠ ‚Üí</button>
      </div>

      <div class="hr"></div>

      <div class="kpiGrid">
        <div class="kpi"><div class="v" id="kpiWorkouts">0</div><div class="k">tr√©ningov</div></div>
        <div class="kpi"><div class="v" id="kpiSets">0</div><div class="k">s√©ri√≠</div></div>
        <div class="kpi"><div class="v" id="kpiReps">0</div><div class="k">opakovan√≠</div></div>
      </div>

      <div class="hr"></div>

      <div id="weekList" class="small">‚Äî</div>
    </div>
  </section>
</main>

<script>
  const APP_VERSION = "1.1.0";
  const LAST_VER_KEY = "fitlog_last_version_v1";

  // ‚úÖ Ak je nov√° verzia appky, zma≈æ cache glob√°lnych cvikov (aby sa natiahli nov√©)
  const last = localStorage.getItem(LAST_VER_KEY);
  if (last !== APP_VERSION) {
    localStorage.removeItem("fitlog_global_exercises_v1");
    localStorage.setItem(LAST_VER_KEY, APP_VERSION);
  }

  // ‚úÖ PWA: registr√°cia + auto reload pri update
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
    navigator.serviceWorker.addEventListener("controllerchange", () => window.location.reload());
  }

  const $ = (id) => document.getElementById(id);

  // üîÅ FALLBACK CVIKY (len keƒè by ne≈°iel exercises.json a nie je cache)
  const BASE_EXERCISES = [
    { id: "drep", label: "Drep" },
    { id: "bench_press", label: "Bench press" },
    { id: "mrtvy_tah", label: "M≈ïtvy ≈•ah" }
  ];

  // --- Storage keys ---
  const KEY_ACTIVE = "fitlog_active_v1";
  const KEY_HISTORY = "fitlog_history_v1";
  const KEY_WEEK_ANCHOR = "fitlog_week_anchor_v1";
  const KEY_MONTH_ANCHOR = "fitlog_month_anchor_v1";

  const KEY_TEMPLATES = "fitlog_templates_v1";

  // --- State ---
  let warmup = false;
  let useRPE = false;
  let active = { date: todayISO(), note: "", dayType: "", sets: [], planExercises: [] };
  let exercises = [];
  let templates = loadTemplates();
  let history = loadHistory();
  let weekAnchor = loadWeekAnchor();
  let monthAnchor = loadMonthAnchor();

  // --- Init UI ---
  init();

  async function init(){
    $("workoutDate").value = active.date || todayISO();
    $("pillDate").innerText = formatDate(active.date);

    const savedDraft = localStorage.getItem(KEY_ACTIVE);
    if (savedDraft) {
      try { active = JSON.parse(savedDraft); } catch(e){}
    }

    // sync UI from draft
    $("workoutDate").value = active.date || todayISO();
    $("workoutNote").value = active.note || "";
    $("dayType").value = active.dayType || "";
    $("pillDate").innerText = formatDate(active.date || todayISO());

    $("workoutDate").addEventListener("change", () => {
      const d = $("workoutDate").value || todayISO();
      active.date = d;
      $("pillDate").innerText = formatDate(d);
      saveDraft();
      renderLog();
      renderCalendar();
    });

    $("workoutNote").addEventListener("input", () => {
      active.note = $("workoutNote").value || "";
      saveDraft();
    });

    $("dayType").addEventListener("input", () => {
      active.dayType = $("dayType").value || "";
      saveDraft();
      syncWorkoutTemplateSelect();
      // kalend√°r je len ukazovateƒæ, ale keƒè ulo≈æ√≠≈° tr√©ning, prenesie sa tam;
      // draft v kalend√°ri nezobrazujeme (aby to bolo ƒçist√©)
    });

    await populateExercises();
    // ≈°abl√≥ny (lok√°lne)
    templates = loadTemplates();
    renderTemplatesUI();
    syncWorkoutTemplateSelect();
    renderTodayPlan();
    renderLog();
    renderHistory();
    renderWeek();
    renderCalendar();
  }

  // --- Tabs ---
  function goTab(name){
    const tabs = ["workout","calendar","history","week"];
    tabs.forEach(t => {
      $("tab-"+t).classList.toggle("active", t===name);
      $("screen-"+t).classList.toggle("hidden", t!==name);
    });
    if (name==="history") renderHistory();
    if (name==="week") renderWeek();
    if (name==="calendar") { renderCalendar(); renderTemplatesUI(); }
    if (name==="workout") { syncWorkoutTemplateSelect(); renderTodayPlan(); }
  }

  // --- Workout ---
  function toggleWarmup(){
    warmup = !warmup;
    $("wuBtn").classList.toggle("accent", warmup);
    $("wuBtn").textContent = warmup ? "Warm-up: ON" : "Warm-up: OFF";
  }

  function toggleRPE(){
    useRPE = !useRPE;
    $("rpeBtn").classList.toggle("accent", useRPE);
    $("rpeBtn").textContent = useRPE ? "RPE: ON" : "RPE: OFF";
    $("rpeBox").classList.toggle("hidden", !useRPE);
    if (!useRPE) $("rpe").value = "";
  }

  function saveSet(){
    const exId = $("exercise").value;
    const exLabel = $("exercise").selectedOptions[0]?.textContent || exId;

    const kgRaw = ($("kg").value || "").trim();
    const repsRaw = ($("reps").value || "").trim();
    const rpeRaw = ($("rpe").value || "").trim();

    if (!kgRaw || !repsRaw) return alert("Zadaj kg aj opakovania.");

    const kg = Number(kgRaw.replace(",", "."));
    const reps = Number(repsRaw);
    const rpe = (useRPE && rpeRaw) ? Number(rpeRaw.replace(",", ".")) : null;

    if (!Number.isFinite(kg) || kg < 0) return alert("Zl√© kg");
    if (!Number.isFinite(reps) || reps <= 0) return alert("Zl√© opakovania");
    if (rpe !== null && (!Number.isFinite(rpe) || rpe < 0 || rpe > 10)) return alert("RPE 0‚Äì10");

    active.sets.push({ exId, exLabel, kg, reps, rpe, warmup, ts: new Date().toISOString() });

    // ak e≈°te nem√°≈° pl√°n cvikov, buduj ho automaticky podƒæa ulo≈æen√Ωch s√©ri√≠
    active.planExercises = Array.isArray(active.planExercises) ? active.planExercises : [];
    if (!active.planExercises.includes(exId)) active.planExercises.push(exId);

    $("kg").value = "";
    $("reps").value = "";
    $("rpe").value = "";

    saveDraft();
    renderLog();
  }

  function renderLog(){
    $("pillDate").innerText = formatDate(active.date || $("workoutDate").value || todayISO());
    $("pillSets").innerText = `${active.sets.length} s√©ri√≠`;

    const div = $("log");
    div.innerHTML = "";
    if (active.sets.length === 0) {
      div.innerHTML = `<div class="small">Zatiaƒæ ≈æiadne s√©rie.</div>`;
      return;
    }

    [...active.sets].slice().reverse().forEach((s, idx) => {
      const isWU = s.warmup ? " ‚Ä¢ WU" : "";
      const rpeTxt = (s.rpe !== null && s.rpe !== undefined) ? ` ‚Ä¢ RPE ${s.rpe}` : "";
      div.innerHTML += `
        <div class="setLine">
          <div class="setMain">
            <strong>${escapeHTML(s.exLabel)}</strong>
            <div class="setMeta">${s.kg} kg √ó ${s.reps}${rpeTxt}${isWU}</div>
          </div>
          <button class="miniBtn" onclick="deleteSet(${active.sets.length - 1 - idx})">Zmaza≈•</button>
        </div>
      `;
    });
  }

  function deleteSet(index){
    active.sets.splice(index, 1);
    saveDraft();
    renderLog();
  }

  function clearLog(){
    if (!confirm("Vymaza≈• v≈°etky s√©rie v tomto dni?")) return;
    active.sets = [];
    saveDraft();
    renderLog();
  }

  function finishWorkout(){
    if (active.sets.length === 0) return alert("Najprv ulo≈æ aspo≈à jednu s√©riu.");

    const d = active.date || $("workoutDate").value || todayISO();
    const entry = {
      id: uid(),
      date: d,
      dayType: ($("dayType").value || active.dayType || "").trim(),
      note: ($("workoutNote").value || active.note || "").trim(),
      sets: active.sets,
      savedAt: new Date().toISOString()
    };

    history = history.filter(h => h.date !== d);
    history.unshift(entry);
    saveHistory();

    // reset draft (zostane d√°tum, aby si nemusel znovu prep√≠na≈•)
    active = { date: d, note: "", dayType: "", sets: [], planExercises: [] };
    $("workoutNote").value = "";
    $("dayType").value = "";
    warmup = false;
    useRPE = false;
    $("wuBtn").classList.remove("accent");
    $("wuBtn").textContent = "Warm-up: OFF";
    $("rpeBtn").classList.remove("accent");
    $("rpeBtn").textContent = "RPE: OFF";
    $("rpeBox").classList.add("hidden");
    $("rpe").value = "";

    saveDraft();
    renderLog();
    renderHistory();
    renderWeek();
    renderCalendar();
    alert("Tr√©ning ulo≈æen√Ω.");
  }

  function saveDraft(){
    localStorage.setItem(KEY_ACTIVE, JSON.stringify(active));
  }

  // --- Exercises (GLOBAL from exercises.json + LOCAL custom) ---
  function loadExercisesLocal() {
    const saved = localStorage.getItem("fitlog_custom_exercises_v1");
    try { return saved ? JSON.parse(saved) : []; } catch { return []; }
  }

  function loadGlobalCached() {
    const saved = localStorage.getItem("fitlog_global_exercises_v1");
    try { return saved ? JSON.parse(saved) : []; } catch { return []; }
  }

  async function syncFromGitHubExercises(force=false) {
    // cache-bust v≈ædy, aby iPhone nevracal star√∫ verziu
    const url = `./exercises.json?v=${Date.now()}&ver=${encodeURIComponent(APP_VERSION)}`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("Cannot load exercises.json");
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error("exercises.json must be an array");
    localStorage.setItem("fitlog_global_exercises_v1", JSON.stringify(data));
    return data;
  }

  async function loadExercises() {
    let global = [];
    try { global = await syncFromGitHubExercises(); }
    catch { global = loadGlobalCached(); }

    if (!Array.isArray(global) || global.length === 0) global = BASE_EXERCISES;

    const custom = loadExercisesLocal();
    const map = new Map();

    [...global, ...custom].forEach(e => {
      if (e && e.id && e.label) map.set(e.id, e);
    });

    return [...map.values()].sort((a,b) => String(a.label).localeCompare(String(b.label)));
  }

  async function populateExercises(){
    const sel = $("exercise");
    sel.innerHTML = "";
    exercises = await loadExercises();
    exercises.forEach(e => {
      const opt = document.createElement("option");
      opt.value = e.id;
      opt.textContent = e.label;
      sel.appendChild(opt);
    });
  }

  async function forceRefreshExercises(){
    try {
      localStorage.removeItem("fitlog_global_exercises_v1");
      await populateExercises();
      alert("Cviky obnoven√©.");
    } catch(e) {
      alert("Nepodarilo sa obnovi≈• cviky (sk√∫s znova).");
    }
  }

  function addExercise(){
    const name = ($("newExName").value || "").trim();
    if (!name) return alert("Zadaj n√°zov cviku.");

    const item = { id: "u_" + uid(), label: name };
    const custom = Array.isArray(loadExercisesLocal()) ? loadExercisesLocal() : [];
    custom.push(item);
    localStorage.setItem("fitlog_custom_exercises_v1", JSON.stringify(custom));

    $("newExName").value = "";
    $("newExNote").value = "";

    const box = $("exExport");
    if (box) box.value = JSON.stringify(item);

    populateExercises();
    alert("Cvik pridan√Ω lok√°lne. Skop√≠ruj export do exercises.json na GitHube a commitni.");
  }

  function copyExport(){
    const box = $("exExport");
    if (!box || !box.value) return alert("Najprv pridaj cvik.");
    box.select();
    document.execCommand("copy");
    alert("Export skop√≠rovan√Ω.");
  }

  // --- Calendar (monthly indicator) ---
  function loadMonthAnchor(){
    const saved = localStorage.getItem(KEY_MONTH_ANCHOR);
    if (saved) return saved;
    const d = todayISO();
    localStorage.setItem(KEY_MONTH_ANCHOR, d);
    return d;
  }

  function shiftMonth(delta){
    const d = new Date(monthAnchor + "T00:00:00");
    d.setMonth(d.getMonth() + delta);
    // ukotvi na 1. de≈à mesiaca
    d.setDate(1);
    monthAnchor = toISO(d);
    localStorage.setItem(KEY_MONTH_ANCHOR, monthAnchor);
    renderCalendar();
  }

  function renderCalendar(){
    history = loadHistory();

    const anchor = new Date(monthAnchor + "T00:00:00");
    const year = anchor.getFullYear();
    const month = anchor.getMonth(); // 0-11

    const monthName = anchor.toLocaleString("sk-SK", { month: "long" });
    $("calTitle").innerText = `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${year}`;

    // range pill
    const startISO = toISO(new Date(year, month, 1));
    const endISO = toISO(new Date(year, month+1, 0));
    $("pillCalRange").innerText = `${formatDate(startISO)} ‚Äì ${formatDate(endISO)}`;

    // header days
    const dows = ["Po","Ut","St","≈†t","Pi","So","Ne"];
    $("calDow").innerHTML = dows.map(x=>`<div class="calDow">${x}</div>`).join("");

    // build grid
    const first = new Date(year, month, 1);
    const last = new Date(year, month+1, 0);

    // convert JS Sunday=0..Saturday=6 to Monday=0..Sunday=6
    const firstDow = (first.getDay() + 6) % 7;
    const daysInMonth = last.getDate();

    // previous month padding
    const prevLast = new Date(year, month, 0);
    const prevDays = prevLast.getDate();

    const cells = [];

    // map of workouts by date
    const byDate = new Map(history.map(h => [h.date, h]));

    for (let i=0; i<firstDow; i++) {
      const dayNum = prevDays - (firstDow - 1 - i);
      const d = new Date(year, month-1, dayNum);
      const iso = toISO(d);
      cells.push(renderCalCell(iso, dayNum, true, byDate.get(iso)));
    }

    for (let day=1; day<=daysInMonth; day++) {
      const d = new Date(year, month, day);
      const iso = toISO(d);
      cells.push(renderCalCell(iso, day, false, byDate.get(iso)));
    }

    // next month padding to full weeks
    const total = cells.length;
    const rem = total % 7;
    const add = rem === 0 ? 0 : 7 - rem;
    for (let i=1; i<=add; i++) {
      const d = new Date(year, month+1, i);
      const iso = toISO(d);
      cells.push(renderCalCell(iso, i, true, byDate.get(iso)));
    }

    $("calGrid").innerHTML = cells.join("");
  }

  function renderCalCell(iso, num, muted, workout){
    const tag = workout?.dayType ? escapeHTML(workout.dayType) : (workout ? "Tr√©ning" : "");
    const dot = workout ? '<span class="dot"></span>' : '';
    const tagHtml = tag ? `<div class="calTagRow">${dot}<div class="calTag">${tag}</div></div>` : `<div class="calTag">&nbsp;</div>`;
    const cls = muted ? "calDay muted" : "calDay";
    return `
      <div class="${cls}" onclick="openDateFromCalendar('${iso}')">
        <div class="calNum">${num}</div>
        ${tagHtml}
      </div>
    `;
  }

  function openDateFromCalendar(dateISO){
    // nastav d√°tum a prepni na tr√©ning
    active.date = dateISO;
    $("workoutDate").value = dateISO;
    $("pillDate").innerText = formatDate(dateISO);

    // ak existuje ulo≈æen√Ω tr√©ning, nechaj ho v Hist√≥rii (u≈æ√≠vateƒæ si ho m√¥≈æe naƒç√≠ta≈•)
    // ale zlep≈°√≠me UX: ak existuje tr√©ning, pon√∫kneme naƒç√≠tanie
    const h = loadHistory().find(x => x.date === dateISO);
    if (h) {
      if (confirm(`N√°jden√Ω tr√©ning pre ${formatDate(dateISO)}. Naƒç√≠ta≈• ho do edit√°cie?`)) {
        active = { date: h.date, note: h.note || "", dayType: h.dayType || "", sets: [...(h.sets||[])], planExercises: [] };
        $("workoutNote").value = active.note || "";
        $("dayType").value = active.dayType || "";
        saveDraft();
      }
    } else {
      // ƒçist√Ω draft pre nov√Ω de≈à
      active.note = "";
      active.dayType = "";
      active.sets = [];
      $("workoutNote").value = "";
      $("dayType").value = "";
      saveDraft();
    }

    renderLog();
    goTab("workout");
  }

  
  // --- Templates (lok√°lne) ---
  function loadTemplates(){
    const saved = localStorage.getItem(KEY_TEMPLATES);
    if (!saved) return [];
    try {
      const arr = JSON.parse(saved);
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }
  function saveTemplates(){
    localStorage.setItem(KEY_TEMPLATES, JSON.stringify(templates));
  }
  function getExerciseLabelById(exId){
    const e = (exercises || []).find(x => x.id === exId);
    return e ? e.label : exId;
  }

  function ensureDefaultTemplate(){
    // ak nem√°≈° niƒç, vytvor√≠me jednu pr√°zdnu, aby UI nebolo ‚Äúm≈ïtve‚Äù
    if (!templates || templates.length === 0){
      templates = [{ id: uid(), name: "Moja ≈°abl√≥na", exIds: [] }];
      saveTemplates();
    }
  }

  function renderTemplatesUI(){
    ensureDefaultTemplate();

    const sel = $("tplSelect");
    const addSel = $("tplAddExercise");
    if (!sel || !addSel) return;

    // select ≈°abl√≥n
    sel.innerHTML = "";
    templates.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = t.name;
      sel.appendChild(opt);
    });

    // obnov posledn√Ω v√Ωber
    const last = localStorage.getItem("fitlog_tpl_selected_v1");
    if (last && templates.some(t=>t.id===last)) sel.value = last;

    sel.onchange = () => {
      localStorage.setItem("fitlog_tpl_selected_v1", sel.value);
      renderTemplateItems();
      syncWorkoutTemplateSelect();
    };

    // select cvikov na pridanie
    addSel.innerHTML = "";
    (exercises || []).forEach(e => {
      const opt = document.createElement("option");
      opt.value = e.id;
      opt.textContent = e.label;
      addSel.appendChild(opt);
    });

    renderTemplateItems();
  }

  function currentTemplate(){
    const sel = $("tplSelect");
    const id = sel?.value;
    return templates.find(t => t.id === id) || templates[0];
  }

  function renderTemplateItems(){
    const box = $("tplItems");
    if (!box) return;

    const t = currentTemplate();
    if (!t) { box.textContent = "‚Äî"; return; }

    if (!Array.isArray(t.exIds) || t.exIds.length === 0){
      box.innerHTML = `<div class="small">≈†abl√≥na je pr√°zdna. Pridaj cviky vy≈°≈°ie.</div>`;
      return;
    }

    box.innerHTML = "";
    t.exIds.forEach((exId, i) => {
      const label = escapeHTML(getExerciseLabelById(exId));
      box.innerHTML += `
        <div class="setLine">
          <div class="setMain">
            <strong>${label}</strong>
            <div class="setMeta">#${i+1}</div>
          </div>
          <div class="row" style="max-width:240px; gap:6px;">
            <button class="miniBtn" onclick="moveTemplateItem(${i}, -1)">‚Üë</button>
            <button class="miniBtn" onclick="moveTemplateItem(${i}, 1)">‚Üì</button>
            <button class="miniBtn" onclick="removeTemplateItem(${i})">X</button>
          </div>
        </div>
      `;
    });
  }

  function createTemplate(){
    const name = prompt("N√°zov ≈°abl√≥ny:", "Nov√° ≈°abl√≥na");
    if (!name) return;
    templates.unshift({ id: uid(), name: name.trim(), exIds: [] });
    saveTemplates();
    localStorage.setItem("fitlog_tpl_selected_v1", templates[0].id);
    renderTemplatesUI();
    syncWorkoutTemplateSelect();
    alert("≈†abl√≥na vytvoren√°.");
  }

  function renameTemplate(){
    const t = currentTemplate();
    if (!t) return;
    const name = prompt("Nov√Ω n√°zov:", t.name);
    if (!name) return;
    t.name = name.trim();
    saveTemplates();
    renderTemplatesUI();
    syncWorkoutTemplateSelect();
  }

  function deleteTemplate(){
    const t = currentTemplate();
    if (!t) return;
    if (!confirm(`Zmaza≈• ≈°abl√≥nu "${t.name}"?`)) return;
    templates = templates.filter(x => x.id !== t.id);
    saveTemplates();
    localStorage.removeItem("fitlog_tpl_selected_v1");
    renderTemplatesUI();
    syncWorkoutTemplateSelect();
  }

  function addExerciseToTemplate(){
    const t = currentTemplate();
    const addSel = $("tplAddExercise");
    if (!t || !addSel) return;
    const exId = addSel.value;
    t.exIds = Array.isArray(t.exIds) ? t.exIds : [];
    t.exIds.push(exId);
    saveTemplates();
    renderTemplateItems();
  }

  function removeTemplateItem(i){
    const t = currentTemplate();
    if (!t) return;
    t.exIds.splice(i, 1);
    saveTemplates();
    renderTemplateItems();
  }

  function moveTemplateItem(i, dir){
    const t = currentTemplate();
    if (!t) return;
    const j = i + dir;
    if (j < 0 || j >= t.exIds.length) return;
    const tmp = t.exIds[i];
    t.exIds[i] = t.exIds[j];
    t.exIds[j] = tmp;
    saveTemplates();
    renderTemplateItems();
  }

  function syncWorkoutTemplateSelect(){
    const sel = $("tplSelectWorkout");
    const pill = $("pillTpl");
    if (!sel || !pill) return;

    ensureDefaultTemplate();

    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "‚Äî vyber ≈°abl√≥nu ‚Äî";
    sel.appendChild(opt0);

    templates.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = t.name;
      sel.appendChild(opt);
    });

    // preferuj ≈°abl√≥nu podƒæa dayType (ak sa zhoduje n√°zov)
    const dt = (active.dayType || $("dayType")?.value || "").trim().toLowerCase();
    const match = templates.find(t => (t.name || "").trim().toLowerCase() === dt);
    const last = localStorage.getItem("fitlog_tpl_selected_workout_v1");

    if (match) sel.value = match.id;
    else if (last && templates.some(t=>t.id===last)) sel.value = last;
    else sel.value = "";

    sel.onchange = () => {
      localStorage.setItem("fitlog_tpl_selected_workout_v1", sel.value);
      pill.textContent = sel.value ? (templates.find(t=>t.id===sel.value)?.name || "‚Äî") : "‚Äî";
    };

    pill.textContent = sel.value ? (templates.find(t=>t.id===sel.value)?.name || "‚Äî") : "‚Äî";
  }

  function applyTemplateToToday(){
    const sel = $("tplSelectWorkout");
    if (!sel || !sel.value) return alert("Najprv vyber ≈°abl√≥nu.");
    const t = templates.find(x => x.id === sel.value);
    if (!t) return;

    active.planExercises = (t.exIds || []).slice();
    saveDraft();
    renderTodayPlan();
    alert("≈†abl√≥na pou≈æit√°.");
  }

  function renderTodayPlan(){
    const wrap = $("tplPlanWrap");
    const list = $("tplPlanList");
    if (!wrap || !list) return;

    const arr = Array.isArray(active.planExercises) ? active.planExercises : [];
    if (arr.length === 0){
      wrap.classList.add("hidden");
      list.innerHTML = "";
      return;
    }

    wrap.classList.remove("hidden");
    list.innerHTML = "";
    arr.forEach(exId => {
      const label = escapeHTML(getExerciseLabelById(exId));
      list.innerHTML += `
        <div class="listItem" onclick="quickPickExercise('${exId}')">
          <div><strong>${label}</strong></div>
          <span class="badge">Vybra≈•</span>
        </div>
      `;
    });
  }

  function quickPickExercise(exId){
    const sel = $("exercise");
    if (!sel) return;
    sel.value = exId;
    // scroll k pridaniu s√©rie
    sel.scrollIntoView({behavior:"smooth", block:"center"});
  }

  function clearTodayPlan(){
    if (!confirm("Vymaza≈• pl√°n cvikov pre dne≈°n√Ω tr√©ning?")) return;
    active.planExercises = [];
    saveDraft();
    renderTodayPlan();
  }

  function savePlanAsTemplate(){
    const arr = Array.isArray(active.planExercises) ? active.planExercises : [];
    if (arr.length === 0) return alert("Najprv pou≈æi ≈°abl√≥nu alebo si sprav pl√°n.");
    const name = prompt("N√°zov ≈°abl√≥ny:", active.dayType || "Nov√° ≈°abl√≥na");
    if (!name) return;
    templates.unshift({ id: uid(), name: name.trim(), exIds: arr.slice() });
    saveTemplates();
    localStorage.setItem("fitlog_tpl_selected_v1", templates[0].id);
    renderTemplatesUI();
    syncWorkoutTemplateSelect();
    alert("≈†abl√≥na ulo≈æen√°.");
  }


  // --- History ---
  function uid(){
    return crypto?.randomUUID?.() || (String(Date.now()) + Math.random().toString(16).slice(2));
  }

  function loadHistory(){
    const saved = localStorage.getItem(KEY_HISTORY);
    if (!saved) return [];
    try {
      const arr = JSON.parse(saved);
      return Array.isArray(arr) ? arr : [];
    } catch {
      return [];
    }
  }

  function saveHistory(){
    localStorage.setItem(KEY_HISTORY, JSON.stringify(history));
  }

  function renderHistory(){
    history = loadHistory();
    $("pillHistory").innerText = String(history.length);
    const list = $("historyList");
    list.innerHTML = "";
    $("historyDetailCard").classList.add("hidden");

    if (history.length === 0) {
      list.innerHTML = `<div class="small">Zatiaƒæ ≈æiadne ulo≈æen√© tr√©ningy.</div>`;
      return;
    }

    history.slice(0, 60).forEach(h => {
      const sets = h.sets?.length || 0;
      const dayType = h.dayType ? ` ‚Ä¢ ${escapeHTML(h.dayType)}` : "";
      list.innerHTML += `
        <div class="listItem" onclick="openHistoryDetail('${h.id}')">
          <div>
            <strong>${formatDate(h.date)}</strong>
            <div class="small">${sets} s√©ri√≠${dayType}</div>
          </div>
          <span class="badge">Detail</span>
        </div>
      `;
    });
  }

  function openHistoryDetail(id){
    history = loadHistory();
    const h = history.find(x => x.id === id);
    if (!h) return;

    $("historyDetailCard").classList.remove("hidden");
    $("historyDetailTitle").innerText = `${formatDate(h.date)}${h.dayType ? " ‚Ä¢ " + h.dayType : ""}`;

    const div = $("historyDetail");
    div.innerHTML = "";

    if (h.note) {
      div.innerHTML += `<div class="card" style="margin:0 0 10px 0;">
        <strong>Pozn√°mka:</strong>
        <div class="small" style="margin-top:6px;">${escapeHTML(h.note)}</div>
      </div>`;
    }

    const grouped = {};
    (h.sets || []).forEach(s => {
      const key = s.exLabel || s.exId;
      grouped[key] = grouped[key] || [];
      grouped[key].push(s);
    });

    Object.keys(grouped).forEach(ex => {
      const arr = grouped[ex];
      div.innerHTML += `<div class="card"><strong>${escapeHTML(ex)}</strong>
        <div class="small" style="margin-top:8px;">${arr.map((s,i)=>{
          const wu = s.warmup ? " (WU)" : "";
          const rpe = (s.rpe!==null && s.rpe!==undefined) ? ` ‚Ä¢ RPE ${s.rpe}` : "";
          return `#${i+1}: ${s.kg}√ó${s.reps}${wu}${rpe}`;
        }).join("<br>")}</div></div>`;
    });

    div.innerHTML += `<button class="btn secondary" onclick="loadWorkoutFromHistory('${h.date}')">Naƒç√≠ta≈• do tr√©ningu</button>`;
  }

  function closeHistoryDetail(){
    $("historyDetailCard").classList.add("hidden");
  }

  function loadWorkoutFromHistory(dateISO){
    history = loadHistory();
    const h = history.find(x => x.date === dateISO);
    if (!h) return;

    active = { date: h.date, note: h.note || "", dayType: h.dayType || "", sets: [...(h.sets || [])], planExercises: [] };
    $("workoutDate").value = active.date;
    $("workoutNote").value = active.note || "";
    $("dayType").value = active.dayType || "";
    active.planExercises = [...new Set((active.sets||[]).map(s=>s.exId).filter(Boolean))];
    saveDraft();
    renderLog();
    goTab("workout");
    alert("Tr√©ning naƒç√≠tan√Ω do edit√°cie.");
  }

  // --- Weekly summary ---
  function loadWeekAnchor(){
    const saved = localStorage.getItem(KEY_WEEK_ANCHOR);
    if (saved) return saved;
    const d = todayISO();
    localStorage.setItem(KEY_WEEK_ANCHOR, d);
    return d;
  }

  function shiftWeek(deltaDays){
    const d = new Date(weekAnchor + "T00:00:00");
    d.setDate(d.getDate() + deltaDays);
    weekAnchor = toISO(d);
    localStorage.setItem(KEY_WEEK_ANCHOR, weekAnchor);
    renderWeek();
  }

  function renderWeek(){
    history = loadHistory();
    const range = weekRangeFor(weekAnchor);
    $("pillWeekRange").innerText = `${formatDate(range.start)} ‚Äì ${formatDate(range.end)}`;

    const inWeek = history.filter(h => h.date >= range.start && h.date <= range.end);

    const workouts = inWeek.length;
    const sets = inWeek.reduce((acc,h)=>acc + ((h.sets||[]).length), 0);
    const reps = inWeek.reduce((acc,h)=>acc + (h.sets||[]).reduce((a,s)=>a + (Number(s.reps)||0), 0), 0);

    $("kpiWorkouts").innerText = String(workouts);
    $("kpiSets").innerText = String(sets);
    $("kpiReps").innerText = String(reps);

    const list = $("weekList");
    if (inWeek.length === 0) {
      list.innerHTML = "≈Ωiadne tr√©ningy v tomto t√Ω≈ædni.";
      return;
    }

    list.innerHTML = inWeek
      .sort((a,b)=>a.date.localeCompare(b.date))
      .map(h => {
        const repsDay = (h.sets||[]).reduce((a,s)=>a + (Number(s.reps)||0), 0);
        const t = h.dayType ? ` ‚Ä¢ ${escapeHTML(h.dayType)}` : "";
        return `<div class="listItem" onclick="goTab('history'); openHistoryDetail('${h.id}')">
          <div>
            <strong>${formatDate(h.date)}${t}</strong>
            <div class="small">${(h.sets||[]).length} s√©ri√≠ ‚Ä¢ ${repsDay} opakovan√≠</div>
          </div>
          <span class="badge">Detail</span>
        </div>`;
      }).join("");
  }

  function weekRangeFor(anchorISO){
    const d = new Date(anchorISO + "T00:00:00");
    const day = d.getDay();
    const diffToMon = (day === 0 ? -6 : 1 - day);
    const start = new Date(d);
    start.setDate(d.getDate() + diffToMon);
    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    return { start: toISO(start), end: toISO(end) };
  }

  // --- Helpers ---
  function todayISO(){ return toISO(new Date()); }
  function toISO(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }
  function formatDate(iso){
    if (!iso) return "‚Äî";
    const [y,m,d] = iso.split("-");
    return `${d}.${m}.${y}`;
  }
  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }
</script>
</body>
</html>
